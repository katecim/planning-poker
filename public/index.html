<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Gopher Poker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
</head>
<body>

    <div class="container">
        <div id="login-screen">
            <h1>ğŸ„ Gopher Poker ğŸ¦«</h1>
            <p style="margin-bottom: 25px; opacity: 0.8;">Enter and start planning.</p>
            <input type="text" id="username" placeholder="What's your name?" autocomplete="off"/>
            <br>
            <button onclick="joinGame()">Enter Session ğŸ</button>
        </div>

        <div id="game-screen" class="hidden">
            <div class="header">
                <div>
                     <h2 style="margin-bottom: 5px;">ğŸ„ Planning Session</h2>
                     <h3 id="session-status">Voting in progress...</h3>
                </div>
               
                <div id="admin-controls" class="hidden">
                    <button class="btn-reveal" onclick="revealCards()">ğŸ‘ï¸ Reveal Cards</button>
                    <button class="btn-reset" onclick="resetGame()">ğŸ”„ New Round</button>
                </div>
            </div>

            <div class="deck" id="deck"></div>

            <div id="results" class="hidden">
                <h3>Team Average</h3>
                <span id="average-score">-</span>
            </div>

            <div class="participants">
                <h3>ğŸ Participants</h3>
                <ul id="user-list"></ul>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
    const socket = io();
    let myId = null;
    
    const cards = [1, 2, 3, 5, 8, 13, 'ğŸ¦«'];

    function joinGame() {
        const name = document.getElementById('username').value;
        if (!name) return alert("Please enter a name");
        
        socket.emit('join', name);
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        renderDeck();
    }

    function renderDeck() {
        const deckDiv = document.getElementById('deck');
        deckDiv.innerHTML = '';
        cards.forEach(val => {
            const btn = document.createElement('button');
            btn.className = 'card';
            // We add a data-value attribute so we can easily find this card later
            btn.setAttribute('data-value', val); 
            btn.innerHTML = typeof val === 'string' ? `<span>${val}</span>` : val;
            
            btn.onclick = () => {
                // Visual feedback immediately on click
                document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
                btn.classList.add('selected');
                socket.emit('vote', val);
            };
            deckDiv.appendChild(btn);
        });
    }

    function revealCards() { socket.emit('reveal'); }
    
    function resetGame() { 
        socket.emit('reset'); 
        // Note: We removed the manual deselect here because the socket.on('update') 
        // below will now handle it for everyone, including the admin.
    }

    socket.on('update', (state) => {
        myId = socket.id;
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        
        let total = 0;
        let count = 0;

        // 1. Find myself to check my vote status
        const me = state.users.find(u => u.id === myId);

        // 2. SYNC DECK SELECTION (The Fix)
        // If the server says I have no vote (e.g., after a Reset), remove all highlights.
        if (me && me.vote === null) {
             document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
        }

        state.users.forEach(u => {
            const li = document.createElement('li');
            
            let voteDisplay = u.vote === null ? '...' : 'ğŸŒ²'; 
            if (state.revealed) {
                voteDisplay = u.vote === null ? '-' : u.vote;
                if (typeof u.vote === 'number') {
                    total += u.vote;
                    count++;
                }
            }

            const adminBadge = u.isAdmin ? '<span class="admin-badge">Guide</span>' : '';
            li.innerHTML = `
                <span class="name">${u.name} ${adminBadge}</span>
                <span class="vote ${state.revealed ? 'revealed' : ''}">${voteDisplay}</span>
            `;
            userList.appendChild(li);

            if (u.id === myId && u.isAdmin) {
                document.getElementById('admin-controls').classList.remove('hidden');
            }
        });

        const resultsDiv = document.getElementById('results');
        
        if (state.revealed) {
            resultsDiv.classList.remove('hidden');
            const avg = count > 0 ? (total / count).toFixed(1) : 0;
            document.getElementById('average-score').innerText = avg;
            document.getElementById('session-status').innerText = "Votes Revealed!";
            document.getElementById('session-status').style.color = "var(--primary-color)";
        } else {
            resultsDiv.classList.add('hidden');
            document.getElementById('session-status').innerText = "Voting in progress...";
            document.getElementById('session-status').style.color = "rgba(255,255,255,0.7)";
        }
    });
</script>
</body>
</html>