<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gopher Planning Poker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
</head>
<body>

    <div class="container">
        <div id="login-screen">
            <h1>Gopher Planning Poker</h1>
            <p style="margin-bottom: 25px; opacity: 0.8;">Enter and start planning.</p>
            <input type="text" id="username" placeholder="What's your name?" autocomplete="off"/>
            <br>
            <button onclick="joinGame()">Enter Session ğŸ†</button>
        </div>

        <div id="game-screen" class="hidden">
            <div class="header">
                <div>
                     <h2 style="margin-bottom: 5px;">Planning Session</h2>
                     <h3 id="session-status">Voting in progress...</h3>
                </div>
               
                <div id="admin-controls" class="hidden">
                    <button class="btn-reveal" onclick="revealCards()">ğŸ‘ï¸ Reveal Cards</button>
                    <button class="btn-reset" onclick="resetGame()">ğŸ”„ New Round</button>
                </div>
            </div>

            <div class="deck" id="deck"></div>

            <div id="results" class="hidden">
                <h3>Team Average</h3>
                <span id="average-score">-</span>
            </div>

            <div class="participants">
                <h3>Participants</h3>
                <ul id="user-list"></ul>
            </div>
        </div>
    </div>

    
    <div class="reaction-bar">
        <button class="reaction-btn" onclick="sendReaction('ğŸ‰', event)">ğŸ‰</button>
        <button class="reaction-btn" onclick="sendReaction('ğŸ’¯', event)">ğŸ’¯</button>
        <button class="reaction-btn" onclick="sendReaction('ğŸ™…â€â™€ï¸', event)">ğŸ™…â€â™€ï¸</button>
        <button class="reaction-btn" onclick="sendReaction('â˜•', event)">â˜•</button>
</div>
    
    <div id="floating-container"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null;
        const cards = [1, 2, 3, 5, 8, 13, 'ğŸ¦«'];

        // --- SESSION PERSISTENCE HELPERS ---
        function getPersistentId() {
            let id = localStorage.getItem('poker_user_id');
            if (!id) {
                id = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('poker_user_id', id);
            }
            return id;
        }

        function joinGame() {
            const name = document.getElementById('username').value;
            if (!name) return alert("Please enter a name");
            
            const persistentId = getPersistentId();
            localStorage.setItem('poker_username', name);

            // Send persistent identity to server
            socket.emit('join', { name, persistentId });
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            renderDeck();
        }

        // Auto-rejoin on refresh if we have a saved name
        window.onload = () => {
            const savedName = localStorage.getItem('poker_username');
            if (savedName) {
                document.getElementById('username').value = savedName;
                joinGame();
            }
        };

        function renderDeck() {
            const deckDiv = document.getElementById('deck');
            deckDiv.innerHTML = '';
            cards.forEach(val => {
                const btn = document.createElement('button');
                btn.className = 'card';
                // We add a data-value attribute so we can easily find this card later
                btn.setAttribute('data-value', val); 
                btn.innerHTML = typeof val === 'string' ? `<span>${val}</span>` : val;
                
                btn.onclick = () => {
                    // Visual feedback immediately on click
                    document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
                    btn.classList.add('selected');
                    socket.emit('vote', val);
                };
                deckDiv.appendChild(btn);
            });
        }

        function revealCards() { socket.emit('reveal'); }
        
        function resetGame() { 
            socket.emit('reset'); 
        }

        socket.on('update', (state) => {
            // Get your persistent ID from storage to identify yourself
            const myPersistentId = localStorage.getItem('poker_user_id');
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            
            let total = 0;
            let count = 0;

            // 1. Find yourself in the state using persistentId instead of socket.id
            const me = state.users.find(u => u.persistentId === myPersistentId);

            // 2. SYNC DECK SELECTION
            if (me && me.vote === null) {
                document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            }

            state.users.forEach(u => {
                const li = document.createElement('li');
                
                let voteDisplay = u.vote === null ? '...' : 'âœ”ï¸'; 
                if (state.revealed) {
                    voteDisplay = u.vote === null ? '-' : u.vote;
                    if (typeof u.vote === 'number') {
                        total += u.vote;
                        count++;
                    }
                }

                const adminBadge = u.isAdmin ? '<span class="admin-badge">Guide</span>' : '';
                li.innerHTML = `
                    <span class="name">${u.name} ${adminBadge}</span>
                    <span class="vote ${state.revealed ? 'revealed' : ''}">${voteDisplay}</span>
                `;
                userList.appendChild(li);

                // Check if THIS user in the loop is ME and if I am the ADMIN
                if (u.persistentId === myPersistentId && u.isAdmin) {
                    document.getElementById('admin-controls').classList.remove('hidden');
                }
            });

            // Update Results UI
            const resultsDiv = document.getElementById('results');
            
            if (state.revealed) {
                resultsDiv.classList.remove('hidden');
                const avg = count > 0 ? (total / count).toFixed(1) : 0;
                document.getElementById('average-score').innerText = avg;
                document.getElementById('session-status').innerText = "Votes Revealed!";
                document.getElementById('session-status').style.color = "var(--primary-color)";
            } else {
                resultsDiv.classList.add('hidden');
                document.getElementById('session-status').innerText = "Voting in progress...";
                document.getElementById('session-status').style.color = "rgba(255,255,255,0.7)";
            }
        });

        // 1. Send Reaction with Position Data
        function sendReaction(emoji, event) {
            // Calculate the button's center position relative to the screen width
            const rect = event.target.getBoundingClientRect();
            const centerX = rect.left + (rect.width / 2);
            
            // Convert to percentage (0% to 100%) so it works on different screen sizes
            const xPercent = (centerX / window.innerWidth) * 100;
            
            socket.emit('reaction', { emoji, x: xPercent });
        }

        // 2. Receive and Animate
        socket.on('reaction', (data) => {
            const emojiChar = data.emoji || data; 
            const xPos = data.x || 90;

            const container = document.body;
            const el = document.createElement('div');
            el.innerText = emojiChar;
            el.className = 'floater';
            
            const randomOffset = (Math.random() * 1) - 0.5; 
            
            el.style.left = (xPos + randomOffset) + '%'; 
            el.style.bottom = '80px'; 

            container.appendChild(el);

            setTimeout(() => {
                el.remove();
            }, 4000);
        });
    </script>
</body>
</html>